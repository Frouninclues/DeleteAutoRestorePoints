$shadows=@();$cur=@{ID=$null;CreationTime=$null};vssadmin list shadows | % {if($_ -match "(?i)Shadow Copy ID:\s+(?<id>{[^}]+})"){ $cur.ID=$Matches.id.Trim() } if($_ -match "(?i)creation time:\s+(?<time>.+)"){ $cur.CreationTime=[datetime]::Parse($Matches.time) } if($cur.ID -and $cur.CreationTime){$shadows+=[pscustomobject]@{ID=$cur.ID;CreationTime=$cur.CreationTime};$cur=@{ID=$null;CreationTime=$null}}};$t=60;Get-ComputerRestorePoint | ? {$_.RestorePointType -ne 16} | % {try{$dt=[Management.ManagementDateTimeConverter]::ToDateTime($_.CreationTime)}catch{continue};$shadows | ? { $_.CreationTime.Date -eq $dt.Date -and ([math]::Abs((($_.CreationTime-$dt).TotalMinutes)) -le $t)} | % { $id=$_.ID.Trim(); Write-Output "Deleting shadow: $id"; & vssadmin.exe delete shadows "/Shadow=$id" "/Quiet" } }
